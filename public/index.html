<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>EBD Webview</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css">
  
  <style>
    body { padding: 10px; padding-bottom: 80px; }
    /* Estilo para a linha do aluno ficar clicÃ¡vel */
    .aluno-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #eee;
      background: white;
    }
    /* Checkbox grande para dedo */
    .big-check { width: 25px; height: 25px; }

    .grid-chamada {
      display: grid;
      /* 1Âª coluna (Nome): FlexÃ­vel | 2Âª, 3Âª, 4Âª colunas: 60px fixos */
      grid-template-columns: 1fr 60px 60px 60px; 
      gap: 10px;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    /* Centraliza o conteÃºdo das colunas de checkbox */
    .col-center {
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    /* Labels do cabeÃ§alho (BÃ­blia, Revista...) */
    .header-label {
      font-size: 0.8rem;
      font-weight: 800;
    }

    /* 2. Nomes dos Alunos - Contraste mÃ¡ximo */
    .aluno-nome {
      color: #000;
      font-weight: 600;
    }

    /* Ajuste para Checkbox ficar grande e fÃ¡cil de tocar */
    input[type="checkbox"] {
      transform: scale(1.5); /* Aumenta o tamanho */
      margin: 0;
      cursor: pointer;
    }

    .label-black {
      font-weight: bold;
      color: #000;
    }

    input {
      font-weight: 500;
    }

    h6 {
      color: #1565c0 !important; /* Azul mais forte */
      font-weight: bold;
    }

    /* RESPONSIVIDADE (Celular) */
    @media (max-width: 600px) {
      .grid-chamada {
        /* Diminui um pouco as colunas no celular */
        grid-template-columns: 1fr 40px 40px 40px; 
        gap: 5px;
      }
      
      /* Esconde o texto e mostra Ã­cones ou abreviaÃ§Ãµes no celular se precisar */
      .header-label {
        font-size: 0.65rem; 
        overflow: hidden;
        text-overflow: ellipsis;
      }
    }
  </style>
</head>
<body>

  <main class="container">
    <nav>
      <ul><li><strong>EBD Digital</strong></li></ul>
    </nav>

    <article id="painel-selecao">
      <header>Selecione a Classe</header>
      <select id="select-turmas">
        <option value="" disabled selected>Carregando turmas...</option>
      </select>
      <footer>
        <button onclick="iniciarChamada()">Iniciar Chamada</button>
      </footer>
    </article>

    <article id="painel-chamada" style="display: none;">
      <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h5 id="titulo-turma" style="margin:0">Chamada</h5>
          <button onclick="location.reload()" class="secondary outline" style="width: auto; padding: 5px 10px; font-size: 0.8rem">Voltar</button>
        </div>
      </header>
      
      <div id="lista-alunos"></div>

      <section style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border: 1px dashed #aaa;">
      <h6 style="margin-bottom: 10px; color:#1565c0;">ðŸ‘‹ Visitantes (NÃ£o matriculados)</h6>
      <div class="grid">
        <label class="label-black">
          Qtd. Pessoas
          <input type="number" id="vis-qtd" value="0" min="0">
        </label>
        <label class="label-black">
          Trouxeram BÃ­blia
          <input type="number" id="vis-biblia" value="0" min="0">
        </label>
        <label class="label-black">
          Trouxeram Revista
          <input type="number" id="vis-revista" value="0" min="0">
        </label>
      </div>
      </section>

      <footer>
        <label>Data da Aula</label>
        <input type="date" id="data-aula" style="margin-bottom: 20px;">

        <label>Oferta do dia (R$)</label>
        <input type="number" id="valor-oferta" placeholder="0,00">
        
        <button onclick="salvarChamadaDefinitiva()">Salvar Tudo</button>
      </footer>
    </article>

    <div id="status-area"></div>
  </main>
  <script>
    const SENHA_PROFESSOR = "803ebd"; // <--- Mude a senha aqui se quiser
    
    // Verifica se jÃ¡ tem a senha salva no navegador
    const senhaSalva = localStorage.getItem("senha_professor");

    if (senhaSalva !== SENHA_PROFESSOR) {
      const tentativa = prompt("Ãrea do Professor: Digite a senha de acesso:");
      
      if (tentativa === SENHA_PROFESSOR) {
        // Se acertou, salva para nÃ£o pedir de novo
        localStorage.setItem("senha_professor", SENHA_PROFESSOR);
      } else {
        // Se errou, apaga a tela e manda embora
        alert("Acesso Negado!");
        document.body.innerHTML = "<h1 style='text-align:center; margin-top:50px'>ðŸ”’ Acesso Negado</h1>";
        throw new Error("Parando execuÃ§Ã£o"); // Trava o resto do script
      }
    }

    const API_URL = '';
    
    // VariÃ¡veis Globais
    let alunosCarregados = [];
    let turmaAtualId = ""; 

    // 1. Carregar Turmas ao abrir a tela
    async function carregarTurmas() {
      try {
        const resposta = await fetch(`${API_URL}/turmas`);
        const turmas = await resposta.json();
        const select = document.getElementById('select-turmas');
        
        select.innerHTML = '<option value="" disabled selected>Escolha uma turma</option>';
        turmas.forEach(turma => {
          select.innerHTML += `<option value="${turma.id}">${turma.nome}</option>`;
        });
      } catch (erro) {
        console.error(erro);
        document.getElementById('status-area').innerHTML = `<p style="color:red">Erro: Servidor offline ou falha na conexÃ£o.</p>`;
      }
    }

    // 2. BotÃ£o Iniciar Chamada
    async function iniciarChamada() {
      const select = document.getElementById('select-turmas');
      const turmaId = select.value;
      const nomeTurma = select.options[select.selectedIndex].text;

      if (!turmaId) return alert("Por favor, selecione uma turma!");

      select.disabled = true;

      try {
        const res = await fetch(`${API_URL}/turmas/${turmaId}/alunos`);
        if (!res.ok) throw new Error("Erro na resposta da API");

        alunosCarregados = await res.json();
        
        // Desenha a tela passando o ID corretamente
        renderizarChamada(nomeTurma, turmaId);
        
      } catch (err) {
        console.error(err);
        alert("Erro ao buscar alunos. Verifique se o servidor estÃ¡ rodando.");
      } finally {
        select.disabled = false;
      }
    }

    // 3. FunÃ§Ã£o que desenha o HTML dos alunos (Com BÃ­blias e Revistas)
    function renderizarChamada(nomeTurma, idTurma) {
      turmaAtualId = idTurma; // Guarda o ID Globalmente
      
      document.getElementById('painel-selecao').style.display = 'none';
      document.getElementById('painel-chamada').style.display = 'block';
      document.getElementById('titulo-turma').innerText = nomeTurma;

      const hoje = new Date().toISOString().split('T')[0]; // Pega YYYY-MM-DD
      document.getElementById('data-aula').value = hoje;

      const lista = document.getElementById('lista-alunos');
      lista.innerHTML = '';

      if (alunosCarregados.length === 0) {
        lista.innerHTML = '<p style="text-align:center">Nenhum aluno.</p>';
        return;
      }

      // CabeÃ§alho
      const header = document.createElement('div');
      header.className = 'grid-chamada'; // <--- Mesma classe das linhas
      header.style.borderBottom = "2px solid #ccc"; // Destaque visual
      header.innerHTML = `
          <div></div> <div class="col-center header-label">BÃ­blia</div>
          <div class="col-center header-label">Revista</div>
          <div class="col-center header-label">Pres.</div>
      `;
      lista.appendChild(header);

      // Lista de Alunos
      alunosCarregados.forEach((aluno, index) => {
        // --- FILTRO DE INATIVOS ---
        // Se o campo 'ativo' for estritamente false, pula esse aluno
        if (aluno.ativo === false) return; // Filtro de inativos
        const linha = document.createElement('div');
        linha.className = 'grid-chamada'; // <--- USA A MESMA CLASSE DO HEADER
        
        // IDs Ãºnicos para os checkboxes
        const idPresenca = `presenca-${index}`;
        const idBiblia = `biblia-${index}`;
        const idRevista = `revista-${index}`;

        linha.innerHTML = `
            <div style="font-weight:bold;">${aluno.nome}</div>

            <div class="col-center">
                <input type="checkbox" id="${idBiblia}" ${aluno.trouxe_biblia ? 'checked' : ''}>
            </div>

            <div class="col-center">
                <input type="checkbox" id="${idRevista}" ${aluno.trouxe_revista ? 'checked' : ''}>
            </div>

            <div class="col-center">
                <input type="checkbox" id="${idPresenca}" ${aluno.presente ? 'checked' : ''}>
            </div>
        `;
        lista.appendChild(linha);
      });
    }

    // 4. FunÃ§Ã£o de Salvar no Banco
    async function salvarChamadaDefinitiva() {
      const inputOferta = document.getElementById('valor-oferta').value;
      const valorOferta = inputOferta ? parseFloat(inputOferta) : 0;
      const dataEscolhida = document.getElementById('data-aula').value;

      const visQtd = parseInt(document.getElementById('vis-qtd').value) || 0;
      const visBiblia = parseInt(document.getElementById('vis-biblia').value) || 0;
      const visRevista = parseInt(document.getElementById('vis-revista').value) || 0;
      
      const listaParaEnviar = alunosCarregados
        .filter(a => a.ativo !== false) // SÃ³ salva quem estÃ¡ ativo
        .map(aluno => {
            // Agora os IDs batem exatamente com o que foi criado no HTML
            // Nota: usei 'presenca-' no HTML, entÃ£o busco 'presenca-' aqui
            const elPresente = document.getElementById(`presenca-${aluno.id}`);
            const elBiblia = document.getElementById(`biblia-${aluno.id}`);
            const elRevista = document.getElementById(`revista-${aluno.id}`);

            return {
              id: aluno.id,
              nome: aluno.nome,
              // O ?.checked evita erro se o elemento nÃ£o for encontrado por algum motivo
              presente: elPresente ? elPresente.checked : false,       
              trouxe_biblia: elBiblia ? elBiblia.checked : false,    
              trouxe_revista: elRevista ? elRevista.checked : false   
            };
        });

      const botao = document.querySelector('footer button');
      const textoOriginal = botao.innerText;
      botao.disabled = true;
      botao.innerText = "Salvando...";

      try {
        const resposta = await fetch(`${API_URL}/chamada`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            turma_id: turmaAtualId,
            oferta: valorOferta,
            alunos: listaParaEnviar,
            data_aula: dataEscolhida,
            visitantes: {
                quantidade: visQtd,
                biblias: visBiblia,
                revistas: visRevista
            }
          })
        });

        const dados = await resposta.json();
        
        if (dados.sucesso) {
          alert("âœ… Chamada salva com sucesso!");
          location.reload(); 
        } else {
          alert("Erro ao salvar: " + (dados.erro || "Desconhecido"));
        }

      } catch (erro) {
        console.error(erro);
        alert("Erro de conexÃ£o com o servidor.");
      } finally {
        botao.disabled = false;
        botao.innerText = textoOriginal;
      }
    }

    carregarTurmas();
  </script>

</body>
</html>