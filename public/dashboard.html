<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Financeiro</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css">
  <style>
    body { padding: 20px; }
    
    /* Card de Resumo Geral */
    .card-money { background: #1565c0; color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .money-value { font-size: 2.5rem; font-weight: bold; margin-top: 10px; }
    
    /* Agrupamento por Data */
    .grupo-data { margin-bottom: 40px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #f9f9f9; }
    .header-data { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 15px; }
    .header-data h4 { margin: 0; color: #333; }
    .tag-total { background-color: #2e7d32; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; font-weight: bold; }

    table { width: 100%; font-size: 0.9rem; background: white; }
    th { background-color: #eee; color: #444; }
    td, th { padding: 10px; text-align: left; }
    
    /* Responsividade simples para celular */
    @media (max-width: 600px) {
      .header-data { flex-direction: column; gap: 10px; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <main class="container">
    <nav>
      <ul><li><strong>Painel Financeiro EBD</strong></li></ul>
      <ul>
        <li><a href="index.html" role="button" class="outline">Chamada</a></li>
        <li><a href="cadastro.html" role="button" class="outline">Secretaria</a></li>
      </ul>
    </nav>

    <section>
      <div class="card-money">
        <small>Caixa Total Acumulado</small>
        <div class="money-value" id="total-geral">R$ 0,00</div>
      </div>
    </section>

    <section id="area-relatorios">
      <p aria-busy="true">Carregando dados financeiros...</p>
    </section>

  </main>

  <script>
    const SENHA_ADM = "admin803"; // <--- Senha mais forte para o tesoureiro/pastor
    
    const senhaSalvaAdm = localStorage.getItem("senha_adm");

    if (senhaSalvaAdm !== SENHA_ADM) {
      const tentativa = prompt("Ãrea Restrita (Diretoria): Digite a senha:");
      
      if (tentativa === SENHA_ADM) {
        localStorage.setItem("senha_adm", SENHA_ADM);
      } else {
        alert("Acesso Negado!");
        document.body.innerHTML = "<h1 style='text-align:center; margin-top:50px'>ðŸ”’ Acesso Restrito Ã  Diretoria</h1>";
        // Opcional: Redirecionar para a chamada se errar a senha da diretoria
        setTimeout(() => window.location.href = "index.html", 2000);
        throw new Error("Parando execuÃ§Ã£o");
      }
    }
    // Se o frontend estÃ¡ na pasta public, a URL base Ã© vazia
    const API_URL = ''; 

    async function carregarDashboard() {
      try {
        // Passo 1: Buscar Turmas (Para saber os nomes)
        const resTurmas = await fetch(`${API_URL}/turmas`);
        const listaTurmas = await resTurmas.json();
        
        // Cria um "DicionÃ¡rio" para achar nome rÃ¡pido: { 'id123': 'Jovens', ... }
        const mapaTurmas = {};
        listaTurmas.forEach(t => mapaTurmas[t.id] = t.nome);

        // Passo 2: Buscar RelatÃ³rios
        const resRelatorios = await fetch(`${API_URL}/relatorios`);
        const listaRelatorios = await resRelatorios.json();

        // Passo 3: Agrupar por Data
        const grupos = {}; // Vai guardar: { '30/12/2025': { total: 50, itens: [...] } }
        let caixaGeral = 0;

        listaRelatorios.forEach(item => {
          caixaGeral += item.oferta_total;
          
          const data = item.data_formatada;
          if (!grupos[data]) {
            grupos[data] = { totalDia: 0, aulas: [] };
          }
          
          grupos[data].totalDia += item.oferta_total;
          grupos[data].aulas.push(item);
        });

        // Passo 4: Desenhar na Tela
        document.getElementById('total-geral').innerText = formatarMoeda(caixaGeral);
        const area = document.getElementById('area-relatorios');
        area.innerHTML = ''; // Limpa o "Carregando..."

        // Pega as datas (chaves) e ordena (opcional, jÃ¡ vem do banco ordenado mas garante)
        const datas = Object.keys(grupos); 

        if (datas.length === 0) {
            area.innerHTML = '<p>Nenhum relatÃ³rio encontrado.</p>';
            return;
        }

        datas.forEach(data => {
            const grupo = grupos[data];
            const nomeDia = obterDiaSemana(data); // Ex: "Domingo"

            let somaMatr = 0, somaPres = 0, somaAus = 0, somaVis = 0;
            let somaOferta = 0, somaBib = 0, somaRev = 0;

            grupo.aulas.forEach(aula => {
                // Extrai os dados de cada aula para somar
                const vis = aula.resumo.visitantes || { quantidade: 0, biblias: 0, revistas: 0 };
                const matriculados = aula.detalhes_alunos ? aula.detalhes_alunos.length : 0;
                
                // Tenta pegar do resumo, se nÃ£o tiver conta na mÃ£o
                const presentes = aula.resumo.presentes !== undefined 
                    ? aula.resumo.presentes 
                    : (aula.detalhes_alunos || []).filter(a => a.presente).length;

                // SomatÃ³rios
                somaMatr += matriculados;
                somaPres += presentes;
                somaAus += (matriculados - presentes);
                somaVis += (vis.quantidade || 0);
                somaOferta += (aula.oferta_total || 0);
                
                // BÃ­blias e Revistas (Soma Membros + Visitantes)
                somaBib += (aula.resumo.biblias || 0) + (vis.biblias || 0);
                somaRev += (aula.resumo.revistas || 0) + (vis.revistas || 0);
            });

            // MÃ©dia de FrequÃªncia da Igreja toda no dia
            const percGeral = somaMatr > 0 ? ((somaPres / somaMatr) * 100).toFixed(2) : "0.00";
            const corPercGeral = parseFloat(percGeral) < 50 ? 'red' : 'green';
            // ----------------------------------------

            // HTML do Grupo (CabeÃ§alho do Dia + Tabela)
            const divGrupo = document.createElement('div');
            divGrupo.className = 'grupo-data';
            divGrupo.innerHTML = `
                <div class="header-data">
                    <div>
                        <h4>ðŸ“… ${data} <small style="font-weight:normal; color:#666">(${nomeDia})</small></h4>
                    </div>
                    <span class="tag-total" style="background:${somaOferta > 0 ? '#2e7d32' : '#777'}">
                        Total Dia: ${formatarMoeda(somaOferta)}
                    </span>
                </div>
                
                <table role="grid" style="font-size: 0.85rem">
                    <thead>
                        <tr>
                            <th>Turma</th>
                            <th title="Total de Matriculados">Matr.</th>
                            <th title="Total de Presentes">Pres.</th>
                            <th title="Total de Ausentes">Aus.</th>
                            <th>% Freq.</th>
                            <th>Visit.</th>
                            <th>Oferta</th>
                            <th>Bib/Rev</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${grupo.aulas.map(aula => {
                            // CÃ¡lculos individuais da linha (Turma)
                            const vis = aula.resumo.visitantes || { quantidade: 0, biblias: 0, revistas: 0 };
                            const matriculados = aula.detalhes_alunos ? aula.detalhes_alunos.length : 0;
                            const presentes = aula.resumo.presentes !== undefined ? aula.resumo.presentes : (aula.detalhes_alunos || []).filter(a => a.presente).length;
                            const ausentes = matriculados - presentes;
                            const percentual = matriculados > 0 ? ((presentes / matriculados) * 100).toFixed(2) : "0.00";
                            const corFreq = parseFloat(percentual) < 50 ? 'red' : '#666';
                            const tBib = (aula.resumo.biblias || 0) + (vis.biblias || 0);
                            const tRev = (aula.resumo.revistas || 0) + (vis.revistas || 0);

                            return `
                                <tr>
                                    <td>
                                        <strong>${mapaTurmas[aula.turma_id] || 'Turma Desconhecida'}</strong>
                                        <br><small style="color:red; cursor:pointer; font-size:0.7rem" onclick="excluirRelatorio('${aula.id}')">[x] Excluir</small>
                                    </td>
                                    <td style="text-align:center">${matriculados}</td>
                                    <td style="text-align:center; color:green">${presentes}</td>
                                    <td style="text-align:center; color:#d32f2f">${ausentes}</td>
                                    <td style="text-align:center; color:${corFreq}; font-weight:bold">${percentual}%</td>
                                    <td style="text-align:center; background-color:#f0f8ff">${vis.quantidade}</td>
                                    <td style="color:${aula.oferta_total > 0 ? '#1565c0' : '#aaa'}">${formatarMoeda(aula.oferta_total)}</td>
                                    <td style="text-align:center; font-size:0.8rem">ðŸ“– ${tBib}<br>ðŸ“˜ ${tRev}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                    
                    <tfoot style="font-weight:bold; background-color:#eee; border-top: 2px solid #aaa;">
                        <tr>
                            <td>TOTAIS</td>
                            <td style="text-align:center">${somaMatr}</td>
                            <td style="text-align:center; color:green">${somaPres}</td>
                            <td style="text-align:center; color:#d32f2f">${somaAus}</td>
                            <td style="text-align:center; color:${corPercGeral}">${percGeral}%</td>
                            <td style="text-align:center; background-color:#e3f2fd">${somaVis}</td>
                            <td style="color:#1565c0">${formatarMoeda(somaOferta)}</td>
                            <td style="text-align:center; font-size:0.8rem">
                                ðŸ“– ${somaBib}<br>ðŸ“˜ ${somaRev}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            `;
            area.appendChild(divGrupo);
        });

      } catch (erro) {
        console.error(erro);
        alert("Erro ao processar dados. Verifique o console.");
      }
    }

    // FunÃ§Ãµes Auxiliares
    function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function obterDiaSemana(dataString) {
        // dataString vem como "30/12/2025"
        const partes = dataString.split('/');
        // O Date do JS pede ano-mÃªs-dia. MÃªs comeÃ§a em 0 (janeiro).
        const dataObj = new Date(partes[2], partes[1] - 1, partes[0]);
        const dias = ['Domingo', 'Segunda', 'TerÃ§a', 'Quarta', 'Quinta', 'Sexta', 'SÃ¡bado'];
        return dias[dataObj.getDay()];
    }

    async function excluirRelatorio(id) {
      if (!confirm("Tem certeza que deseja apagar este relatÃ³rio? O dinheiro serÃ¡ subtraÃ­do do total.")) return;

      try {
        const res = await fetch(`${API_URL}/relatorios/${id}`, { method: 'DELETE' });
        if (res.ok) {
          alert("RelatÃ³rio apagado!");
          carregarDashboard(); // Recarrega a tela para atualizar o valor total
        } else {
          alert("Erro ao apagar.");
        }
      } catch (e) {
        alert("Erro de conexÃ£o.");
      }
    }

    carregarDashboard();
  </script>
</body>
</html>