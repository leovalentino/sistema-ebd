<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Secretaria</title>

  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css">

  <link rel="stylesheet" href="style.css?v=1.1">

  <style>
    /* Ajuste de Layout */
    @media (min-width: 1000px)  {
      body { padding-left: 50px; padding-right: 50px }
    }

    /* --- Componentes do Di√°rio --- */
    .header-data {
      background: #f8f9fa;
      border-left: 5px solid #1e88e5;
      padding: 15px;
      margin-bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      border-radius: 8px 8px 0 0;
    }

    .titulo-dia {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tag-total {
      color: #f8f9fa;
      padding: 0.5em 0.8em;
      border-radius: 25px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    /* Info Extra (Secret√°rio, Clima) */
    .info-extra {
      background: #f8f9fa;
      padding: 5px 15px 15px 15px;
      margin-bottom: 5px;
      border-left: 5px solid #1e88e5;
      font-size: 0.9rem;
      color: #555;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    /* Bot√µes Pequenos */
    .btn-sm {
      padding: 4px 10px;
      font-size: 0.8rem;
      background-color: #ffb300;
      border: none;
      color: black;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      margin-bottom: 0;
      font-weight: 500;
    }
    .btn-sm:hover { background-color: #ffca28; }

    /* Tabelas */
    table {
      width: 100%;
      font-size: 0.9rem;
      background: white;
      margin-bottom: 40px;
      border-radius: 8px;
      overflow: hidden; /* Para bordas arredondadas */
    }
    th { background-color: #e0e0e0; color: #111; padding: 10px; text-align: left; }
    td { padding: 10px; color: #222; }
    tfoot { background-color: #cfd8dc !important; color: #000 !important; font-weight: 800; }
    h4 small { color: #444 !important; }

    /* Classes Utilit√°rias para Tabela (substituem styles inline) */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-green { color: green; }
    .text-red { color: #d32f2f; }
    .text-blue { color: #1565c0; }
    .text-muted { color: #aaa; }

    .bg-blue-light { background-color: #f0f8ff; }
    .bg-green-light { background-color: #e8f5e9; color: #1b5e20; }
    .bg-green-total { background-color: #c8e6c9; color: #1b5e20; font-size: 1.1em; }

    .border-bottom-green { border-bottom: 2px solid #4caf50; }
    .prof-info { font-size: 0.75rem; color: #555; font-style: italic; }
    .obs-icon { cursor: help; font-size: 1rem; }
    .delete-btn { color: red; cursor: pointer; font-size: 0.7rem; margin-right: 5px; }

    /* --- Drawer (Painel Lateral) --- */
    .drawer-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 998;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      backdrop-filter: blur(2px);
    }

    .drawer {
      position: fixed;
      top: 0; right: 0;
      width: 400px;
      height: 100vh;
      background: #11191f;
      z-index: 999;
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
      padding: 25px;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
    }

    .drawer.aberto { transform: translateX(0); }
    .drawer-overlay.aberto { opacity: 1; visibility: visible; }

    .drawer header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .close-btn {
      cursor: pointer;
      font-size: 1.5rem;
      line-height: 1;
      padding: 5px;
    }

    .drawer-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      height: 100%;
    }

    .footer-buttons {
      margin-top: auto;
      padding-top: 20px;
      display: flex;
      gap: 10px;
    }
    .footer-buttons button { width: 100%; margin-bottom: 0; }

    /* Responsividade Drawer */
    @media (max-width: 600px) {
      .header-data { flex-direction: column; gap: 10px; align-items: flex-start; }
      .info-extra { flex-direction: column; gap: 5px; }

      .drawer {
        width: 100%;
        max-width: 100vw;
        border-left: none;
      }
      .footer-buttons {
        flex-direction: column-reverse;
        gap: 10px;
      }
      .footer-buttons button {
        width: 100%;
        margin: 0;
        padding: 15px;
      }
    }
  </style>
</head>
<body>

<main class="container">
  <nav>
    <ul><li><strong>Dashboard EBD</strong></li></ul>
    <ul>
      <li><a href="index.html" role="button" class="outline">Chamada</a></li>
      <li><a href="cadastro.html" role="button" class="outline">Secretaria</a></li>
    </ul>
  </nav>

  <section class="dashboard-section" id="area-relatorios">
    <p aria-busy="true">Carregando dados das turmas...</p>
  </section>

  <div id="overlay-drawer" class="drawer-overlay" onclick="fecharPanel()"></div>

  <aside id="painel-dia" class="drawer">
    <header>
      <h3 style="margin:0">üìù Detalhes do Dia <br><small id="lbl-data-painel" style="font-weight:normal; font-size:0.6em; color:#666"></small></h3>
      <span aria-label="Close" class="close-btn" onclick="fecharPanel()">&times;</span>
    </header>

    <form onsubmit="salvarDiario(event)" class="drawer-form">
      <input type="hidden" id="input-data-oculta">

      <div>
        <label><strong>Secret√°rio(a) Respons√°vel</strong></label>
        <input type="text" id="input-secretario" placeholder="Quem fechou o relat√≥rio?">
      </div>

      <div>
        <label><strong>Estado do Tempo</strong></label>
        <select id="select-clima">
          <option value="">Selecione...</option>
          <option value="Ensolarado">‚òÄÔ∏è Ensolarado</option>
          <option value="Nublado">‚òÅÔ∏è Nublado</option>
          <option value="Chuvoso">üåßÔ∏è Chuvoso</option>
          <option value="Frio">‚ùÑÔ∏è Frio</option>
        </select>
      </div>

      <div>
        <label><strong>Observa√ß√µes Gerais</strong></label>
        <textarea id="input-obs" rows="5" placeholder="Avisos, eventos especiais, problemas ocorridos..."></textarea>
      </div>

      <footer class="footer-buttons">
        <button type="button" class="secondary outline" onclick="fecharPanel()">Cancelar</button>
        <button type="submit">üíæ Salvar</button>
      </footer>
    </form>
  </aside>

</main>

<script src="common.js?v=1.0"></script>

<script>
  verificarAcesso();

  const ORDEM_TURMAS = {
    'adultos': 1,
    'jovens': 2,
    'juvenis': 3,
    'primarios': 4,
    'maternal': 5
  };

  async function carregarDashboard() {
    try {
      const area = document.getElementById('area-relatorios');

      const [resTurmas, resRelatorios, resDiario] = await Promise.all([
        fetch(`${API_URL}/turmas`),
        fetch(`${API_URL}/relatorios`),
        fetch(`${API_URL}/diario`)
      ]);

      const listaTurmas = await resTurmas.json();
      const listaRelatorios = await resRelatorios.json();
      const listaDiario = await resDiario.json();

      const mapaTurmas = {};
      listaTurmas.forEach(t => mapaTurmas[t.id] = t.nome);

      const mapaDiario = {};
      listaDiario.forEach(d => mapaDiario[d.data] = d);

      const grupos = {};

      listaRelatorios.sort((a, b) => {
        const nomeA = mapaTurmas[a.turma_id] || "";
        const nomeB = mapaTurmas[b.turma_id] || "";
        return obterPesoTurma(nomeA) - obterPesoTurma(nomeB);
      }).forEach(item => {
        const data = item.data_formatada;
        if (!grupos[data]) {
          grupos[data] = { totalDia: 0, aulas: [] };
        }
        grupos[data].totalDia += item.oferta_total;
        grupos[data].aulas.push(item);
      });

      area.innerHTML = '';
      const datas = Object.keys(grupos);

      if (datas.length === 0) {
        area.innerHTML = '<p>Nenhum relat√≥rio encontrado.</p>';
        return;
      }

      datas.forEach(data => {
        const grupo = grupos[data];
        const infoDia = mapaDiario[data] || {};

        let somaMatr = 0, somaPres = 0, somaAus = 0, somaVis = 0;
        let somaOferta = 0, somaBib = 0, somaRev = 0, somaTotalPessoasDia = 0;

        grupo.aulas.forEach(aula => {
          const vis = aula.resumo.visitantes || { quantidade: 0, biblias: 0, revistas: 0 };
          const matriculados = aula.detalhes_alunos ? aula.detalhes_alunos.length : 0;
          const presentes = aula.resumo.presentes !== undefined
                  ? aula.resumo.presentes
                  : (aula.detalhes_alunos || []).filter(a => a.presente).length;

          somaMatr += matriculados;
          somaPres += presentes;
          somaAus += (matriculados - presentes);
          somaVis += (vis.quantidade || 0);
          somaOferta += (aula.oferta_total || 0);
          somaTotalPessoasDia += (presentes + (vis.quantidade || 0));
          somaBib += (aula.resumo.biblias || 0) + (vis.biblias || 0);
          somaRev += (aula.resumo.revistas || 0) + (vis.revistas || 0);
        });

        const percGeral = somaMatr > 0 ? ((somaPres / somaMatr) * 100).toFixed(2) : "0.00";

        let htmlClima = infoDia.clima ? `<span>${infoDia.clima}</span>` : "";
        let htmlSec = infoDia.secretario ? `<span>üë§ <b>Sec:</b> ${infoDia.secretario}</span>` : "";
        let htmlObs = infoDia.observacoes
                ? `<span tabindex="0" data-tooltip="${infoDia.observacoes.replace(/"/g, '&quot;')}">üìù (Ler Obs)</span>`
                : "";

        if(!htmlClima && !htmlSec && !htmlObs) htmlClima = "<small><i>Sem detalhes extras</i></small>";

        const divGrupo = document.createElement('div');
        divGrupo.className = 'grupo-data';

        divGrupo.innerHTML = `
            <div class="header-data">
                <div class="titulo-dia">
                   <span>üìÖ</span>
                   <span>${data}</span>
                   <button class="btn-sm" onclick="abrirPanel('${data}')">üìÅ Fechar Relat√≥rio</button>
                </div>
                <span class="tag-total" style="background:${percGeral > 50 ? '#2e7d32' : '#d32f2f'}">
                   Total % Presen√ßa: ${percGeral}
                </span>
            </div>

            <div class="info-extra">
                ${htmlClima} ${htmlSec} ${htmlObs}
            </div>

            <table role="grid">
                <thead>
                    <tr>
                        <th>Turma</th>
                        <th title="Total de Matriculados">Matr.</th>
                        <th title="Total de Presentes">Pres.</th>
                        <th title="Total de Ausentes">Aus.</th>
                        <th>% Freq.</th>
                        <th>Visit.</th>
                        <th title="Soma de Membros + Visitantes" class="bg-green-light border-bottom-green">Total</th>
                        <th>Oferta</th>
                        <th>Bib/Rev</th>
                    </tr>
                </thead>
                <tbody>
                    ${grupo.aulas.map(aula => {
          const vis = aula.resumo.visitantes || { quantidade: 0, biblias: 0, revistas: 0 };
          const matriculados = aula.detalhes_alunos ? aula.detalhes_alunos.length : 0;
          const presentes = aula.resumo.presentes !== undefined ? aula.resumo.presentes : (aula.detalhes_alunos || []).filter(a => a.presente).length;
          const ausentes = matriculados - presentes;
          const percentual = matriculados > 0 ? ((presentes / matriculados) * 100).toFixed(2) : "0.00";
          const corFreq = parseFloat(percentual) < 50 ? 'red' : '#666';
          const tBib = (aula.resumo.biblias || 0) + (vis.biblias || 0);
          const tRev = (aula.resumo.revistas || 0) + (vis.revistas || 0);
          const totalPessoasSala = presentes + (vis.quantidade || 0);

          const nomeProf = aula.professor && aula.professor !== "N√£o informado"
                  ? `<div class="prof-info">Prof. ${aula.professor}</div>`
                  : "";

          let htmlObsAula = aula.observacoes
                  ? `<span tabindex="0" data-tooltip="${aula.observacoes.replace(/"/g, '&quot;')}">üìù</span>`
                  : "";

          return `
                            <tr>
                                <td>
                                    <strong>${mapaTurmas[aula.turma_id] || 'Turma Desconhecida'}</strong>
                                    ${nomeProf}
                                    <div style="margin-top:5px">
                                        <small class="delete-btn" onclick="excluirRelatorio('${aula.id}')">[x] Excluir</small>
                                        ${htmlObsAula}
                                    </div>
                                </td>
                                <td class="text-center">${matriculados}</td>
                                <td class="text-center text-green">${presentes}</td>
                                <td class="text-center text-red">${ausentes}</td>
                                <td class="text-center" style="color:${corFreq}; font-weight:bold">${percentual}%</td>
                                <td class="text-center bg-blue-light">${vis.quantidade}</td>
                                <td class="text-center bg-green-light" style="font-weight:bold;">${totalPessoasSala}</td>
                                <td class="${aula.oferta_total > 0 ? 'text-blue' : 'text-muted'}">${formatarMoeda(aula.oferta_total)}</td>
                                <td class="text-center" style="font-size:0.8rem">üìñ ${tBib}<br>üìò ${tRev}</td>
                            </tr>
                        `;
        }).join('')}
                </tbody>

                <tfoot>
                    <tr>
                        <td>TOTAIS</td>
                        <td class="text-center">${somaMatr}</td>
                        <td class="text-center text-green">${somaPres}</td>
                        <td class="text-center text-red">${somaAus}</td>
                        <td class="text-center" style="color:${percGeral < 50 ? 'red' : 'black'}">${percGeral}%</td>
                        <td class="text-center bg-blue-light">${somaVis}</td>
                        <td class="text-center bg-green-total">${somaTotalPessoasDia}</td>
                        <td class="text-blue">${formatarMoeda(somaOferta)}</td>
                        <td class="text-center" style="font-size:0.8rem">üìñ ${somaBib}<br>üìò ${somaRev}</td>
                    </tr>
                </tfoot>
            </table>
        `;
        area.appendChild(divGrupo);
      });

    } catch (erro) {
      console.error(erro);
      alert("Erro ao processar dados. Verifique o console.");
    }
  }

  // Fun√ß√£o Auxiliar: Remove acentos e deixa min√∫sculo
  // Ex: "Prim√°rios" -> "primarios"
  function limparTexto(texto) {
    if (!texto) return "";
    return texto
            .toLowerCase()
            .normalize("NFD") // Separa letras dos acentos
            .replace(/[\u0300-\u036f]/g, ""); // Remove os acentos via Regex
  }

  function obterPesoTurma(nomeTurma) {
    // Limpa a entrada (que vem do banco com acento)
    const nomeLimpo = limparTexto(nomeTurma);

    // Compara com as chaves limpas do HashMap
    for (const [chave, peso] of Object.entries(ORDEM_TURMAS)) {
      if (nomeLimpo.includes(chave)) {
        return peso;
      }
    }

    return 99; // Default (Novos convertidos, Visitantes, etc)
  }

  function formatarMoeda(valor) {
    return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  async function excluirRelatorio(id) {
    const resposta = prompt("‚ö†Ô∏è ZONA DE PERIGO ‚ö†Ô∏è\n\nDigite DELETAR para confirmar a exclus√£o:");
    if (resposta !== "DELETAR") return;

    try {
      const res = await fetch(`${API_URL}/relatorios/${id}`, { method: 'DELETE' });
      if (res.ok) {
        alert("Relat√≥rio apagado com sucesso.");
        carregarDashboard();
      } else {
        alert("Erro ao apagar no servidor.");
      }
    } catch (e) {
      alert("Erro de conex√£o.");
    }
  }

  async function abrirPanel(data) {
    document.getElementById('lbl-data-painel').innerText = data;
    document.getElementById('input-data-oculta').value = data;

    document.getElementById('input-secretario').value = "";
    document.getElementById('select-clima').value = "";
    document.getElementById('input-obs').value = "";

    try {
      const res = await fetch(`${API_URL}/diario`);
      const lista = await res.json();
      const atual = lista.find(d => d.data === data);

      if(atual) {
        document.getElementById('input-secretario').value = atual.secretario || "";
        document.getElementById('select-clima').value = atual.clima || "";
        document.getElementById('input-obs').value = atual.observacoes || "";
      }
    } catch(e) {}

    document.getElementById('painel-dia').classList.add('aberto');
    document.getElementById('overlay-drawer').classList.add('aberto');
    document.body.style.overflow = 'hidden';
  }

  function fecharPanel() {
    document.getElementById('painel-dia').classList.remove('aberto');
    document.getElementById('overlay-drawer').classList.remove('aberto');
    document.body.style.overflow = '';
  }

  async function salvarDiario(e) {
    e.preventDefault();
    const data = document.getElementById('input-data-oculta').value;
    const body = {
      data: data,
      secretario: document.getElementById('input-secretario').value,
      clima: document.getElementById('select-clima').value,
      observacoes: document.getElementById('input-obs').value
    };

    await fetch(`${API_URL}/diario`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });

    fecharPanel();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.removeAttribute('aria-busy');
    carregarDashboard();
  }

  carregarDashboard();
</script>
</body>
</html>