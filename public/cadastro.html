<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secretaria EBD</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css">
  <style>
    body { padding: 20px; }
    .card { padding: 20px; border: 1px solid #333; border-radius: 8px; margin-bottom: 20px; }
    h2 { margin-bottom: 10px; font-size: 1.2rem; border-bottom: 1px solid #444; padding-bottom: 5px; }
  </style>
</head>
<body>
  <main class="container">
    <nav>
      <ul><li><strong>Secretaria EBD</strong></li></ul>
      <ul><li><a href="index.html" role="button" class="outline">Ir para Chamada</a></li></ul>
    </nav>

    <section class="card">
      <h2>Cadastrar Novo Aluno</h2>
      <form onsubmit="cadastrarAluno(event)">
        
        <label>Nome do Aluno</label>
        <input type="text" id="nome-aluno" placeholder="Ex: Jo√£o da Silva" required>

        <label>Data de Nascimento</label>
        <input type="date" id="nasc-aluno" style="margin-bottom: 20px;">

        <label>Selecione a Turma</label>
        <select id="select-turmas" required>
          <option value="" disabled selected>Carregando turmas...</option>
        </select>

        <button type="submit">Cadastrar Aluno</button>
      </form>
    </section>

    <section class="card">
      <h2>Criar Nova Turma</h2>
      <form onsubmit="criarTurma(event)">
        <label>Nome da Turma</label>
        <input type="text" id="nome-nova-turma" placeholder="Ex: Crian√ßas (4-6 anos)" required>
        <button type="submit" class="secondary">Criar Turma</button>
      </form>
    </section>

  </main>

  <script>
    const API_URL = '';

    // 1. Carregar Turmas para o Select
    async function carregarTurmas() {
      try {
        const res = await fetch(`${API_URL}/turmas`);
        const turmas = await res.json();
        const select = document.getElementById('select-turmas');
        
        select.innerHTML = '<option value="" disabled selected>Selecione uma turma...</option>';
        turmas.forEach(t => {
          select.innerHTML += `<option value="${t.id}">${t.nome}</option>`;
        });
        document.getElementById('select-turmas').addEventListener('change', listarAlunosParaEdicao);
      } catch (erro) {
        alert("Erro ao carregar turmas. O servidor est√° rodando?");
      }
    }

    // 2. Fun√ß√£o de Cadastrar Aluno
    async function cadastrarAluno(event) {
      event.preventDefault(); // N√£o deixa a p√°gina recarregar
      
      const nome = document.getElementById('nome-aluno').value;
      const dataNasc = document.getElementById('nasc-aluno').value;
      const turmaId = document.getElementById('select-turmas').value;

      const botao = event.target.querySelector('button');
      botao.disabled = true;
      botao.innerText = "Salvando...";

      try {
        const resposta = await fetch(`${API_URL}/alunos`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            nome: nome,
            turma_id: turmaId,
            data_nascimento: dataNasc,
            ativo: true,
            criado_em: new Date().toISOString()
          })
        });

        if (resposta.ok) {
          alert(`‚úÖ ${nome} cadastrado com sucesso!`);
          document.getElementById('nome-aluno').value = ''; // Limpa o campo
        } else {
          alert("Erro ao cadastrar.");
        }
      } catch (e) {
        alert("Erro de conex√£o.");
      } finally {
        botao.disabled = false;
        botao.innerText = "Cadastrar Aluno";
      }
    }

    // 3. Fun√ß√£o de Criar Turma (Para voc√™ n√£o precisar mexer no banco manualmente)
    async function criarTurma(event) {
      event.preventDefault();
      const nome = document.getElementById('nome-nova-turma').value;
      
      // Pequeno truque: O backend n√£o tem rota espec√≠fica de turmas POST ainda?
      // Vamos usar a API direta do Firestore ou criar a rota no backend depois.
      // Por enquanto, vou assumir que precisamos criar essa rota no Node.
      
      try {
        const res = await fetch(`${API_URL}/turmas`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ nome: nome })
        });
        
        if (res.ok) {
          alert("Turma criada!");
          document.getElementById('nome-nova-turma').value = '';
          carregarTurmas(); // Atualiza o select l√° em cima
        } else {
          alert("Erro: Voc√™ precisa criar a rota POST /turmas no backend para isso funcionar.");
        }
      } catch (e) {
        alert("Erro de conex√£o.");
      }
    }

    // Substitua a fun√ß√£o listarAlunosParaEdicao por esta vers√£o completa:
    async function listarAlunosParaEdicao() {
      const turmaId = document.getElementById('select-turmas').value;
      if (!turmaId) return;

      let areaLista = document.getElementById('lista-edicao');
      if (!areaLista) {
        areaLista = document.createElement('div');
        areaLista.id = 'lista-edicao';
        areaLista.className = 'card';
        areaLista.style.marginTop = '20px';
        document.querySelector('main').appendChild(areaLista);
      }
      areaLista.innerHTML = 'Carregando alunos...';

      const res = await fetch(`${API_URL}/turmas/${turmaId}/alunos`);
      const alunos = await res.json();

      areaLista.innerHTML = '<h4>‚úèÔ∏è Toque para editar</h4>';
      
      if (alunos.length === 0) areaLista.innerHTML += '<p>Sem alunos.</p>';

      alunos.forEach(aluno => {
       if (aluno.ativo === false) return; 

        const linha = document.createElement('div');
        linha.style.padding = "15px";
        linha.style.borderBottom = "1px solid #eee";
        linha.style.display = "flex";
        linha.style.justifyContent = "space-between";
        linha.style.alignItems = "center";
        
        // Coluna 1: Nome
        const divNome = document.createElement('div');
        divNome.style.flex = "1";
        divNome.style.cursor = "pointer";
        divNome.innerHTML = `<strong>${aluno.nome}</strong>`;
        divNome.onclick = () => editarCampo(aluno.id, 'nome', aluno.nome, 'text');

        // Coluna 2: A√ß√µes (Data + Excluir)
        const divAcoes = document.createElement('div');
        divAcoes.style.display = 'flex';
        divAcoes.style.gap = '15px';
        divAcoes.style.alignItems = 'center';

        // Data
        let dataFormatada = "--/--";
        if (aluno.data_nascimento) {
            const partes = aluno.data_nascimento.split('-');
            dataFormatada = `${partes[2]}/${partes[1]}`;
        }
        
        const spanData = document.createElement('span');
        spanData.innerText = `üìÖ ${dataFormatada}`;
        spanData.style.cursor = "pointer";
        spanData.style.fontSize = "0.9rem";
        spanData.onclick = () => editarCampo(aluno.id, 'data_nascimento', aluno.data_nascimento, 'date');

        // Bot√£o Excluir (Soft Delete)
        const btnExcluir = document.createElement('span');
        btnExcluir.innerText = "üóëÔ∏è";
        btnExcluir.style.cursor = "pointer";
        btnExcluir.title = "Desativar Aluno";
        btnExcluir.onclick = async () => {
            if (confirm(`Deseja remover ${aluno.nome} da lista de chamada?`)) {
                await desativarAluno(aluno.id);
            }
        };

        divAcoes.appendChild(spanData);
        divAcoes.appendChild(btnExcluir);

        linha.appendChild(divNome);
        linha.appendChild(divAcoes);
        areaLista.appendChild(linha);
      });
    }

    // Fun√ß√£o gen√©rica para editar qualquer campo
    async function editarCampo(id, campo, valorAtual, tipoInput) {
        // Se for data, o prompt n√£o √© o ideal, mas funciona se digitar AAAA-MM-DD.
        // Vamos fazer um truque simples: usar o prompt mesmo.
        
        let novoValor;
        if (tipoInput === 'date') {
            const instrucao = valorAtual ? `(Atual: ${valorAtual})` : '(vazio)';
            novoValor = prompt(`Digite a nova data (AAAA-MM-DD) ${instrucao}:`, valorAtual);
        } else {
            novoValor = prompt(`Editar ${campo}:`, valorAtual);
        }

        if (novoValor && novoValor !== valorAtual) {
            const payload = {};
            payload[campo] = novoValor; // Cria objeto din√¢mico { nome: "..." } ou { data_nascimento: "..." }

            try {
                await fetch(`${API_URL}/alunos/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                listarAlunosParaEdicao(); // Atualiza a lista
            } catch (e) { alert("Erro ao salvar"); }
        }
    }

    async function editarNomeAluno(id, novoNome) {
      try {
        await fetch(`${API_URL}/alunos/${id}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ nome: novoNome })
        });
        alert("Nome atualizado!");
      } catch (e) { alert("Erro ao editar"); }
    }

    async function desativarAluno(id) {
      try {
        await fetch(`${API_URL}/alunos/${id}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ ativo: false }) // <--- O PULO DO GATO
        });
        listarAlunosParaEdicao(); // Atualiza a lista e o aluno some
      } catch (e) {
        alert("Erro ao desativar aluno.");
      }
    }

    carregarTurmas();
  </script>
</body>
</html>